# 開発ガイドライン

本ガイドは TypeScript 実装時の共通ルールをまとめたものです。
開発中に疑問が生じた場合は本ドキュメントを参照し、基準が不足している場合は追記します。

## 技術スタック
- **使用言語**: TypeScript 5.9 以上。ターゲットは `ES2023`、トランスパイルは Node.js 24.x（Active LTS）を前提にする。
- **モジュールシステム**: ESM を既定（`"type": "module"`）。CommonJS を使う場合は個別に理由を残す。
- **依存管理**: `pnpm` を使用する。新規パッケージの追加は `pnpm add <pkg>`、開発依存は `pnpm add -D <pkg>` で lockfile を更新する。
- **ビルド / 実行**: `tsc --noEmit` で型検査し、ランタイム実行は `tsx` もしくは `node --loader ts-node/esm` のどちらかに統一する。

## TDD ワークフロー
1. 実装対象の期待振る舞いを `tests/` 配下の `*.test.ts` で `vitest` を用いて定義する。
2. 失敗するテストを確認してから、`src/` 以下に最小限の実装を追加する。
3. `pnpm test`（=`vitest --run`）を実行して緑化し、必要であればリファクタリングを行う。
4. バグ修正時も必ず再発防止テストを先に追加し、修正後のテスト通過を確認する。

## ディレクトリおよび命名
- アプリケーションコードは `src/` 直下に配置し、ドメイン単位でフォルダ分割する。
- テストは `tests/` に鏡写しのパス構成で配置する（例: `src/tasks/store.ts` → `tests/tasks/store.test.ts`）。
- テスト用フィクスチャは `tests/fixtures/` にまとめ、実在データは置かない。
- TypeScript の型定義ファイルを分離する場合は `*.types.ts` または `types/` ディレクトリを用いる。

## コーディング規約
- `tsconfig.json` は `strict: true` / `noImplicitAny: true` / `exactOptionalPropertyTypes: true` を維持し、`skipLibCheck` は無効化しない。
- 公開 API（エクスポートする関数・クラス・型）には明示的な戻り値型・ジェネリック境界を付ける。暗黙の `any` / `unknown` は許容しない。
- サイドエフェクトのある処理はファイル冒頭でまとめて記述し、モジュール初期化時の副作用を最小化する。
- オブジェクトリテラルは `as const` を活用し、リテラル型を落とさない。
- デフォルトエクスポートは使用禁止とし、すべて名前付きエクスポートでモジュール依存を明瞭にする。
- エクスポートする関数・クラスには TSDoc 形式のコメントで役割や副作用を記述する（引数・戻り値は型が明瞭なら省略可）。内部関数でも複雑な処理は目的をコメントで補足する。
- ドメイン知識や例外的な意図がある箇所にコメントを付け、冗長な説明は避ける。

## 例外処理とロギング
- 予期しない例外を握りつぶさず、必要に応じて `Error` を継承した独自例外で文脈情報を追加する。
- ログは `pino` 等の構造化ロガー経由で記録し、`console.log` は一時的なデバッグ用途のみに留める。
- エラーメッセージにはユーザー影響とリカバリー手段を含め、LLM から参照される前提で簡潔かつ具体的に書く。

## テスト運用
- テストランナーは `vitest` を採用し、`pnpm test` を最低限の実行コマンドとする。
- ユースケースのバリエーションは `describe` / `it` と `test.each` を用いてパラメタライズする。
- ファイルシステム・時刻などの外部依存はモックする。
- 各テストケースには意図を表すディスクリプション（英語の命題形）を付け、セットアップや期待結果が一目で分かるように適宜コメントを追加する（最低でも各テストに1つの補足コメントを入れる）。コメントは日本語で記述し、状況説明や想定を明確化する。

## 品質ツール
- `pnpm lint` で `eslint`（`@typescript-eslint` プラグイン含む）を実行し、警告・エラー共にゼロを維持する。
- `pnpm typecheck` で `tsc --noEmit` を実行し、型エラーを CI で検知する。
- フォーマッタは `pnpm format`（`prettier`）に統一し、自動整形はコミット前に走らせる。

## バージョン管理
- 1 機能 1 ブランチを原則とし、ブランチ名は `feature/<short-desc>` 形式を採用する。
- 変更は論理単位ごとにコミットし、コミットメッセージには目的と主な変更点を記述する。

## セキュリティとデータ
- API キーや機微情報は `.env` / `secrets/` 等の外部ファイルで管理し、バージョン管理対象に含めない。
- テスト・ローカル検証にはダミーデータを使用し、顧客情報や本番ログをリポジトリに持ち込まない。
- 外部サービスと通信する際は `.env.example` に必要な環境変数を追加し、最小権限のキーを利用する。
